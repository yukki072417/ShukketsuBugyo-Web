services:
  setup:
    image: alpine:latest
    container_name: setup
    volumes:
      - .:/workspace
    working_dir: /workspace
    command: >
      sh -c "
        apk add --no-cache openssl bash &&
        echo '必要なディレクトリを作成中...' &&
        mkdir -p certs secrets front-end/dist db/mysql_datas back-end/logs &&
        if [ ! -d 'certs' ] || [ ! -f 'certs/server.crt' ]; then
          echo 'SSL証明書を生成中...' &&
          cd certs &&
          openssl req -x509 -newkey rsa:4096 -keyout server.key -out server.crt -days 365 -nodes -subj '/C=JP/ST=Tokyo/L=Tokyo/O=Demo/CN=localhost' &&
          openssl req -new -x509 -key server.key -out ca.crt -days 365 -subj '/C=JP/ST=Tokyo/L=Tokyo/O=Demo/CN=localhost' &&
          cd ..
        fi &&
        if [ ! -d 'secrets' ] || [ ! -f 'secrets/aes.key' ]; then
          echo '暗号化キーを生成中...' &&
          ./generate_key.sh
        fi &&
        echo 'セットアップ完了'
      "

  mysql:
    container_name: db
    image: mysql:8.0
    restart: always
    tty: true
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: SHUKKETSU_BUGYO
    volumes:
      - ./db/mysql_datas:/var/lib/mysql
      - ./db/migrations:/etc/mysql/conf.d
    networks:
      - app-network
    depends_on:
      setup:
        condition: service_completed_successfully
      
  nginx:
    container_name: web
    image: nginx
    restart: always
    ports:
      - "443:443"
    volumes:
      - "./front-end/dist:/var/www/"
      - "./certs:/etc/nginx/certs/"
      - "./configs/default.conf:/etc/nginx/conf.d/default.conf"
    networks:
      - app-network
    depends_on:
      - application
      
  application:
    container_name: app
    build:
      context: .
      dockerfile: ./docker/dockerfile
    ports:
      - "3000:3000"
    volumes:
      - "./secrets:/app/secrets:ro"
      - "./back-end/src:/app/src"
      - "./back-end/package.json:/app/package.json"
      - "./back-end/package-lock.json:/app/package-lock.json"
      - "./back-end/nodemon.json:/app/nodemon.json"
      - "./back-end/.eslintrc.js:/app/.eslintrc.js"
      - "./back-end/.env:/app/.env"
      - "./back-end/logs:/app/logs"
      - "./certs:/app/certs/"
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: SHUKKETSU_BUGYO
    networks:
      - app-network
    depends_on:
      setup:
        condition: service_completed_successfully
      mysql:
        condition: service_started
    command: npm start

networks:
  app-network:
    driver: bridge