'use strict';

module.exports = {
  async up(queryInterface, Sequelize) {
    // 1. TENANTS
    await queryInterface.createTable('TENANTS', {
      TENANT_ID: {
        type: Sequelize.STRING(30),
        primaryKey: true,
        allowNull: false
      },
      TENANT_NAME: {
        type: Sequelize.STRING(255),
        allowNull: false
      },
      TENANT_NAME_EN: {
        type: Sequelize.STRING(255),
        allowNull: false
      }
    }, {
      charset: 'utf8mb4',
      collate: 'utf8mb4_unicode_ci'
    });

    // 2. TEACHERS
    await queryInterface.createTable('TEACHERS', {
      TENANT_ID: {
        type: Sequelize.STRING(30),
        primaryKey: true,
        allowNull: false
      },
      TEACHER_ID: {
        type: Sequelize.STRING(20),
        primaryKey: true,
        allowNull: false
      },
      PASSWORD: {
        type: Sequelize.STRING(255),
        allowNull: false
      },
      MANAGER: {
        type: Sequelize.BOOLEAN,
        allowNull: false,
        defaultValue: false
      }
    }, {
      charset: 'utf8mb4',
      collate: 'utf8mb4_unicode_ci'
    });

    await queryInterface.addConstraint('TEACHERS', {
      fields: ['TENANT_ID'],
      type: 'foreign key',
      name: 'fk_teachers_tenant',
      references: { table: 'TENANTS', field: 'TENANT_ID' },
      onDelete: 'CASCADE',
      onUpdate: 'CASCADE'
    });

    // 3. COURSES
    await queryInterface.createTable('COURSES', {
      TENANT_ID: {
        type: Sequelize.STRING(30),
        primaryKey: true,
        allowNull: false
      },
      COURSE_ID: {
        type: Sequelize.CHAR(36),
        primaryKey: true,
        allowNull: false
      },
      COURSE_NAME: {
        type: Sequelize.STRING(50),
        allowNull: false
      },
      COURSE_NAME_EN: {
        type: Sequelize.STRING(50),
        allowNull: false
      }
    }, {
      charset: 'utf8mb4',
      collate: 'utf8mb4_unicode_ci'
    });

    await queryInterface.addConstraint('COURSES', {
      fields: ['TENANT_ID'],
      type: 'foreign key',
      name: 'fk_courses_tenant',
      references: { table: 'TENANTS', field: 'TENANT_ID' },
      onDelete: 'CASCADE',
      onUpdate: 'CASCADE'
    });

    // 4. CLASSES
    await queryInterface.createTable('CLASSES', {
      TENANT_ID: {
        type: Sequelize.STRING(30),
        primaryKey: true,
        allowNull: false
      },
      GRADE: {
        type: Sequelize.CHAR(1),
        primaryKey: true,
        allowNull: true
      },
      CLASS: {
        type: Sequelize.STRING(15),
        primaryKey: true,
        allowNull: true
      },
      TEACHER_ID: {
        type: Sequelize.STRING(20),
        allowNull: false
      }
    }, {
      charset: 'utf8mb4',
      collate: 'utf8mb4_unicode_ci'
    });

    await queryInterface.addConstraint('CLASSES', {
      fields: ['TENANT_ID'],
      type: 'foreign key',
      name: 'fk_classes_tenant',
      references: { table: 'TENANTS', field: 'TENANT_ID' },
      onDelete: 'CASCADE',
      onUpdate: 'CASCADE'
    });

    await queryInterface.addConstraint('CLASSES', {
      fields: ['TENANT_ID', 'TEACHER_ID'],
      type: 'foreign key',
      name: 'fk_classes_teacher',
      references: { table: 'TEACHERS', fields: ['TENANT_ID', 'TEACHER_ID'] },
      onDelete: 'CASCADE',
      onUpdate: 'CASCADE'
    });

    // 5. STUDENTS
    await queryInterface.createTable('STUDENTS', {
      TENANT_ID: {
        type: Sequelize.STRING(30),
        primaryKey: true,
        allowNull: false
      },
      STUDENT_ID: {
        type: Sequelize.STRING(20),
        primaryKey: true,
        allowNull: false
      },
      PASSWORD: {
        type: Sequelize.STRING(255),
        allowNull: false
      },
      GRADE: {
        type: Sequelize.CHAR(1),
        allowNull: true
      },
      CLASS: {
        type: Sequelize.STRING(15),
        allowNull: true
      },
      NUMBER: {
        type: Sequelize.TINYINT.UNSIGNED,
        allowNull: true
      },
      COURSE_ID: {
        type: Sequelize.CHAR(36),
        allowNull: true
      }
    }, {
      charset: 'utf8mb4',
      collate: 'utf8mb4_unicode_ci'
    });

    await queryInterface.addConstraint('STUDENTS', {
      fields: ['TENANT_ID'],
      type: 'foreign key',
      name: 'fk_students_tenant',
      references: { table: 'TENANTS', field: 'TENANT_ID' },
      onDelete: 'CASCADE',
      onUpdate: 'CASCADE'
    });

    await queryInterface.addIndex('STUDENTS', ['COURSE_ID'], {
      name: 'idx_students_course_id'
    });

    await queryInterface.addIndex('STUDENTS', ['GRADE', 'CLASS'], {
      name: 'idx_students_grade_class'
    });

    // 6. LESSONS
    await queryInterface.createTable('LESSONS', {
      TENANT_ID: {
        type: Sequelize.STRING(30),
        primaryKey: true,
        allowNull: false
      },
      LESSON_ID: {
        type: Sequelize.CHAR(36),
        primaryKey: true,
        allowNull: false
      },
      TEACHER_ID: {
        type: Sequelize.STRING(20),
        allowNull: false
      },
      LESSON_NAME: {
        type: Sequelize.STRING(255),
        allowNull: true
      },
      LESSON_NAME_EN: {
        type: Sequelize.STRING(255),
        allowNull: true
      },
      GRADE: {
        type: Sequelize.CHAR(1),
        allowNull: false
      }
    }, {
      charset: 'utf8mb4',
      collate: 'utf8mb4_unicode_ci'
    });

    await queryInterface.addConstraint('LESSONS', {
      fields: ['TENANT_ID'],
      type: 'foreign key',
      name: 'fk_lessons_tenant',
      references: { table: 'TENANTS', field: 'TENANT_ID' },
      onDelete: 'CASCADE',
      onUpdate: 'CASCADE'
    });

    await queryInterface.addConstraint('LESSONS', {
      fields: ['TENANT_ID', 'TEACHER_ID'],
      type: 'foreign key',
      name: 'fk_lessons_teacher',
      references: { table: 'TEACHERS', fields: ['TENANT_ID', 'TEACHER_ID'] },
      onDelete: 'CASCADE',
      onUpdate: 'CASCADE'
    });

    await queryInterface.addIndex('LESSONS', ['TENANT_ID', 'TEACHER_ID'], {
      name: 'idx_lessons_teacher'
    });

    await queryInterface.addIndex('LESSONS', ['GRADE'], {
      name: 'idx_lessons_grade'
    });

    // 7. ENROLLMENTS
    await queryInterface.createTable('ENROLLMENTS', {
      TENANT_ID: {
        type: Sequelize.STRING(30),
        allowNull: false
      },
      ENROLLMENT_ID: {
        type: Sequelize.CHAR(36),
        primaryKey: true,
        allowNull: false
      },
      STUDENT_ID: {
        type: Sequelize.STRING(20),
        allowNull: false
      },
      LESSON_ID: {
        type: Sequelize.CHAR(36),
        allowNull: false
      },
      STATUS: {
        type: Sequelize.TINYINT,
        allowNull: false,
        defaultValue: 1
      }
    }, {
      charset: 'utf8mb4',
      collate: 'utf8mb4_unicode_ci'
    });

    await queryInterface.addConstraint('ENROLLMENTS', {
      fields: ['TENANT_ID', 'STUDENT_ID', 'LESSON_ID'],
      type: 'unique',
      name: 'unique_student_lesson'
    });

    await queryInterface.addConstraint('ENROLLMENTS', {
      fields: ['TENANT_ID'],
      type: 'foreign key',
      name: 'fk_enrollments_tenant',
      references: { table: 'TENANTS', field: 'TENANT_ID' },
      onDelete: 'CASCADE',
      onUpdate: 'CASCADE'
    });

    await queryInterface.addConstraint('ENROLLMENTS', {
      fields: ['TENANT_ID', 'STUDENT_ID'],
      type: 'foreign key',
      name: 'fk_enrollments_student',
      references: { table: 'STUDENTS', fields: ['TENANT_ID', 'STUDENT_ID'] },
      onDelete: 'CASCADE',
      onUpdate: 'CASCADE'
    });

    await queryInterface.addConstraint('ENROLLMENTS', {
      fields: ['TENANT_ID', 'LESSON_ID'],
      type: 'foreign key',
      name: 'fk_enrollments_lesson',
      references: { table: 'LESSONS', fields: ['TENANT_ID', 'LESSON_ID'] },
      onDelete: 'CASCADE',
      onUpdate: 'CASCADE'
    });

    await queryInterface.addIndex('ENROLLMENTS', ['TENANT_ID', 'STUDENT_ID'], {
      name: 'idx_enrollments_student'
    });

    await queryInterface.addIndex('ENROLLMENTS', ['TENANT_ID', 'LESSON_ID'], {
      name: 'idx_enrollments_lesson'
    });

    await queryInterface.addIndex('ENROLLMENTS', ['STATUS'], {
      name: 'idx_enrollments_status'
    });

    // 8. TIME_SLOTS
    await queryInterface.createTable('TIME_SLOTS', {
      TENANT_ID: {
        type: Sequelize.STRING(30),
        primaryKey: true,
        allowNull: false
      },
      PERIOD: {
        type: Sequelize.STRING(20),
        primaryKey: true,
        allowNull: false
      },
      START_TIME: {
        type: Sequelize.TIME,
        allowNull: false
      },
      END_TIME: {
        type: Sequelize.TIME,
        allowNull: false
      }
    }, {
      charset: 'utf8mb4',
      collate: 'utf8mb4_unicode_ci'
    });

    await queryInterface.addConstraint('TIME_SLOTS', {
      fields: ['TENANT_ID'],
      type: 'foreign key',
      name: 'fk_timeslots_tenant',
      references: { table: 'TENANTS', field: 'TENANT_ID' },
      onDelete: 'CASCADE',
      onUpdate: 'CASCADE'
    });

    // 9. TIME_TABLE
    await queryInterface.createTable('TIME_TABLE', {
      TENANT_ID: {
        type: Sequelize.STRING(30),
        primaryKey: true,
        allowNull: false
      },
      LESSON_ID: {
        type: Sequelize.CHAR(36),
        primaryKey: true,
        allowNull: false
      },
      PERIOD: {
        type: Sequelize.STRING(20),
        primaryKey: true,
        allowNull: false
      },
      DAY_OF_WEEK: {
        type: Sequelize.TINYINT.UNSIGNED,
        primaryKey: true,
        allowNull: false
      },
      GRADE: {
        type: Sequelize.CHAR(1),
        primaryKey: true,
        allowNull: false
      },
      CLASS: {
        type: Sequelize.STRING(15),
        primaryKey: true,
        allowNull: false
      }
    }, {
      charset: 'utf8mb4',
      collate: 'utf8mb4_unicode_ci'
    });

    await queryInterface.addConstraint('TIME_TABLE', {
      fields: ['TENANT_ID', 'LESSON_ID'],
      type: 'foreign key',
      name: 'fk_timetable_lesson',
      references: { table: 'LESSONS', fields: ['TENANT_ID', 'LESSON_ID'] },
      onDelete: 'CASCADE',
      onUpdate: 'CASCADE'
    });

    await queryInterface.addConstraint('TIME_TABLE', {
      fields: ['TENANT_ID', 'GRADE', 'CLASS'],
      type: 'foreign key',
      name: 'fk_timetable_class',
      references: { table: 'CLASSES', fields: ['TENANT_ID', 'GRADE', 'CLASS'] },
      onDelete: 'CASCADE',
      onUpdate: 'CASCADE'
    });

    await queryInterface.addConstraint('TIME_TABLE', {
      fields: ['TENANT_ID', 'PERIOD'],
      type: 'foreign key',
      name: 'fk_timetable_timeslot',
      references: { table: 'TIME_SLOTS', fields: ['TENANT_ID', 'PERIOD'] },
      onDelete: 'CASCADE',
      onUpdate: 'CASCADE'
    });

    await queryInterface.addIndex('TIME_TABLE', ['DAY_OF_WEEK', 'TENANT_ID', 'GRADE', 'CLASS'], {
      name: 'idx_timetable_day_grade_class'
    });

    // 10. ATTENDANCE
    await queryInterface.createTable('ATTENDANCE', {
      TENANT_ID: {
        type: Sequelize.STRING(30),
        primaryKey: true,
        allowNull: false
      },
      ENROLLMENT_ID: {
        type: Sequelize.CHAR(36),
        primaryKey: true,
        allowNull: false
      },
      STUDENT_ID: {
        type: Sequelize.STRING(20),
        primaryKey: true,
        allowNull: false
      },
      DATE: {
        type: Sequelize.DATEONLY,
        primaryKey: true,
        allowNull: false
      },
      PERIOD: {
        type: Sequelize.STRING(20),
        primaryKey: true,
        allowNull: false
      },
      STATUS: {
        type: Sequelize.TINYINT,
        allowNull: false,
        defaultValue: 0
      },
      NOTES: {
        type: Sequelize.TEXT,
        allowNull: true
      }
    }, {
      charset: 'utf8mb4',
      collate: 'utf8mb4_unicode_ci'
    });

    await queryInterface.addConstraint('ATTENDANCE', {
      fields: ['TENANT_ID'],
      type: 'foreign key',
      name: 'fk_attendance_tenant',
      references: { table: 'TENANTS', field: 'TENANT_ID' },
      onDelete: 'CASCADE',
      onUpdate: 'CASCADE'
    });

    await queryInterface.addConstraint('ATTENDANCE', {
      fields: ['ENROLLMENT_ID'],
      type: 'foreign key',
      name: 'fk_attendance_enrollment',
      references: { table: 'ENROLLMENTS', field: 'ENROLLMENT_ID' },
      onDelete: 'CASCADE',
      onUpdate: 'CASCADE'
    });

    await queryInterface.addConstraint('ATTENDANCE', {
      fields: ['TENANT_ID', 'STUDENT_ID'],
      type: 'foreign key',
      references: { table: 'STUDENTS', fields: ['TENANT_ID', 'STUDENT_ID'] },
      onDelete: 'CASCADE',
      onUpdate: 'CASCADE'
    });

    await queryInterface.addConstraint('ATTENDANCE', {
      fields: ['TENANT_ID', 'PERIOD'],
      type: 'foreign key',
      name: 'fk_attendance_timeslot',
      references: { table: 'TIME_SLOTS', fields: ['TENANT_ID', 'PERIOD'] },
      onDelete: 'CASCADE',
      onUpdate: 'CASCADE'
    });

    await queryInterface.addIndex('ATTENDANCE', ['DATE', 'STATUS'], {
      name: 'idx_attendance_date_status'
    });

    await queryInterface.addIndex('ATTENDANCE', ['ENROLLMENT_ID', 'DATE'], {
      name: 'idx_attendance_enrollment_date'
    });

    await queryInterface.addIndex('ATTENDANCE', ['TENANT_ID', 'PERIOD'], {
      name: 'idx_attendance_tenant_period'
    });
  },

  async down(queryInterface, Sequelize) {
    await queryInterface.dropTable('ATTENDANCE');
    await queryInterface.dropTable('TIME_TABLE');
    await queryInterface.dropTable('TIME_SLOTS');
    await queryInterface.dropTable('ENROLLMENTS');
    await queryInterface.dropTable('LESSONS');
    await queryInterface.dropTable('STUDENTS');
    await queryInterface.dropTable('CLASSES');
    await queryInterface.dropTable('COURSES');
    await queryInterface.dropTable('TEACHERS');
    await queryInterface.dropTable('TENANTS');
  }
};